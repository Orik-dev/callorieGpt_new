import json
import httpx
from app.config import settings
import logging

logger = logging.getLogger(__name__)

# –£–õ–£–ß–®–ï–ù–ù–´–ô –ü–†–û–ú–ü–¢ - —á–µ—Ç–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
OPENAI_PROMPT = """–¢—ã ‚Äî —Ç–æ—á–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –ø–æ–¥—Å—á–µ—Ç—É –∫–∞–ª–æ—Ä–∏–π –∏ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤.

üéØ –¢–í–û–Ø –ó–ê–î–ê–ß–ê: –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¢–û–õ–¨–ö–û –¢–û, –ß–¢–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –û–¢–ü–†–ê–í–ò–õ –°–ï–ô–ß–ê–° (—Ç–µ–∫—Å—Ç –∏–ª–∏ —Ñ–æ—Ç–æ).
–ù–ï –¥–æ–±–∞–≤–ª—è–π –±–ª—é–¥–∞ –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –≤–∏–¥–∏—à—å. –ù–ï –ø–æ–≤—Ç–æ—Ä—è–π —Ç–æ, —á—Ç–æ –±—ã–ª–æ –≤ –∏—Å—Ç–æ—Ä–∏–∏.

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON):

{
  "items": [
    {
      "name": "–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞",
      "weight_grams": 200,
      "calories": 450.5,
      "protein": 25.0,
      "fat": 15.0,
      "carbs": 50.0,
      "confidence": 0.85
    }
  ],
  "notes": "–ö—Ä–∞—Ç–∫–∏–π —Å–æ–≤–µ—Ç –∏–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è"
}

üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:

1. –ï–°–õ–ò –≠–¢–û –ù–ï –ï–î–ê:
   ‚ùå "–≤–µ–ª–æ—Å–∏–ø–µ–¥", "–º–∞—à–∏–Ω–∞", –º–∞—Ç, –Ω–µ–ø—Ä–∏—Å—Ç–æ–π–Ω–æ—Å—Ç–∏ ‚Üí items=[] –∏ notes="–≠—Ç–æ –Ω–µ –ø—Ä–æ–¥—É–∫—Ç –ø–∏—Ç–∞–Ω–∏—è"
   ‚ùå –ù–ï –ø—ã—Ç–∞–π—Å—è –Ω–∞–π—Ç–∏ –∫–∞–ª–æ—Ä–∏–∏ –¥–ª—è –Ω–µ-–µ–¥—ã!

2. –û–î–ù–û –°–õ–û–í–û = –û–î–ù–û –ë–õ–Æ–î–û (–ù–ï –î–£–ë–õ–ò–†–£–ô!):
   ‚úÖ "–≥—Ä–µ—á–∫–∞" ‚Üí –û–î–ù–û –±–ª—é–¥–æ "–ì—Ä–µ—á–∫–∞ –≤–∞—Ä–µ–Ω–∞—è" 150–≥
   ‚úÖ "–∫—É—Ä–∏—Ü–∞" ‚Üí –û–î–ù–û –±–ª—é–¥–æ "–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞" 150–≥
   ‚ùå –ù–ï —Å–æ–∑–¥–∞–≤–∞–π 2-3 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –±–ª—é–¥–∞ –∏–∑ –æ–¥–Ω–æ–≥–æ —Å–ª–æ–≤–∞!

3. –ü–ï–†–ï–ß–ò–°–õ–ï–ù–ò–ï —á–µ—Ä–µ–∑ "–∏", "—Å", –∑–∞–ø—è—Ç—É—é:
   ‚úÖ "–≥—Ä–µ—á–∫–∞ —Å –∫—É—Ä–∏—Ü–µ–π" ‚Üí –î–í–ê –±–ª—é–¥–∞: –≥—Ä–µ—á–∫–∞ 150–≥ + –∫—É—Ä–∏—Ü–∞ 150–≥
   ‚úÖ "—è–±–ª–æ–∫–æ –∏ –±–∞–Ω–∞–Ω" ‚Üí –î–í–ê –±–ª—é–¥–∞
   ‚úÖ "—Ä–∏—Å, –º—è—Å–æ, —Å–∞–ª–∞—Ç" ‚Üí –¢–†–ò –±–ª—é–¥–∞

4. –°–¢–ê–ù–î–ê–†–¢–ù–´–ï –ü–û–†–¶–ò–ò (–µ—Å–ª–∏ –≤–µ—Å –ù–ï —É–∫–∞–∑–∞–Ω):
   ‚Ä¢ –ì–∞—Ä–Ω–∏—Ä (–∫–∞—à–∞, –º–∞–∫–∞—Ä–æ–Ω—ã, —Ä–∏—Å): 150–≥
   ‚Ä¢ –ú—è—Å–æ/–ø—Ç–∏—Ü–∞/—Ä—ã–±–∞: 150–≥
   ‚Ä¢ –§—Ä—É–∫—Ç —Å—Ä–µ–¥–Ω–∏–π: 150–≥
   ‚Ä¢ –û–≤–æ—â–Ω–æ–π —Å–∞–ª–∞—Ç: 200–≥
   ‚Ä¢ –°—É–ø: 300–º–ª

5. –ï–°–õ–ò –£–ö–ê–ó–ê–ù –í–ï–° - –ò–°–ü–û–õ–¨–ó–£–ô –ï–ì–û:
   ‚úÖ "–≥—Ä–µ—á–∫–∞ 200–≥" ‚Üí weight_grams: 200
   ‚úÖ "–¥–≤–∞ —è–±–ª–æ–∫–∞" ‚Üí 2 –±–ª—é–¥–∞ –ø–æ 150–≥
   ‚úÖ "–ø–æ–ª–æ–≤–∏–Ω–∞ –ø–∏—Ü—Ü—ã" ‚Üí 400–≥ (–ø–æ–ª–æ–≤–∏–Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π ~800–≥)

6. –ù–ê –§–û–¢–û:
   ‚Ä¢ –û–ø—Ä–µ–¥–µ–ª–∏ –í–°–ï –±–ª—é–¥–∞ –∫–æ—Ç–æ—Ä—ã–µ –≤–∏–¥–∏—à—å
   ‚Ä¢ –û—Ü–µ–Ω–∏ –≤–µ—Å –ø–æ —Ä–∞–∑–º–µ—Ä—É —Ç–∞—Ä–µ–ª–∫–∏ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç 24—Å–º)
   ‚Ä¢ 1/4 —Ç–∞—Ä–µ–ª–∫–∏ ‚âà 100-150–≥, 1/2 ‚âà 200-300–≥, –ø–æ–ª–Ω–∞—è ‚âà 400-500–≥

7. –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –≤ "notes":
   ‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –ø–æ –ø–∏—Ç–∞–Ω–∏—é
   ‚Ä¢ –ß—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å/—É–±—Ä–∞—Ç—å –¥–ª—è –±–∞–ª–∞–Ω—Å–∞
   ‚Ä¢ –ü—Ä–∏–º–µ—Ä—ã: "–î–æ–±–∞–≤—å—Ç–µ –æ–≤–æ—â–µ–π", "–û—Ç–ª–∏—á–Ω—ã–π –±–∞–ª–∞–Ω—Å –ë–ñ–£", "–ú–Ω–æ–≥–æ —É–≥–ª–µ–≤–æ–¥–æ–≤ - –¥–æ–±–∞–≤—å—Ç–µ –±–µ–ª–∫–∞"

8. CONFIDENCE (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å):
   ‚Ä¢ 0.9-1.0: —á–µ—Ç–∫–æ –≤–∏–¥–Ω–æ –ø—Ä–æ–¥—É–∫—Ç –ò –≤–µ—Å
   ‚Ä¢ 0.7-0.9: –ø—Ä–æ–¥—É–∫—Ç —è—Å–µ–Ω, –≤–µ—Å –ø—Ä–∏–º–µ—Ä–Ω—ã–π
   ‚Ä¢ 0.5-0.7: –≥—Ä—É–±–∞—è –æ—Ü–µ–Ω–∫–∞
   ‚Ä¢ <0.5: –æ—á–µ–Ω—å –Ω–µ—É–≤–µ—Ä–µ–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞

9. –í–ê–õ–ò–î–ê–¶–ò–Ø:
   ‚Ä¢ –ö–∞–ª–æ—Ä–∏–∏ ‚âà (–±–µ–ª–∫–∏√ó4) + (–∂–∏—Ä—ã√ó9) + (—É–≥–ª–µ–≤–æ–¥—ã√ó4) ¬±10%
   ‚Ä¢ –í—Å–µ —á–∏—Å–ª–∞ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ
   ‚Ä¢ –í–µ—Å 1-2000–≥

–ü–†–ò–ú–ï–†–´:

–ó–∞–ø—Ä–æ—Å: "–≥—Ä–µ—á–∫–∞"
–û—Ç–≤–µ—Ç: {
  "items": [{"name": "–ì—Ä–µ—á–∫–∞ –≤–∞—Ä–µ–Ω–∞—è", "weight_grams": 150, "calories": 150, "protein": 5.0, "fat": 1.0, "carbs": 30.0, "confidence": 0.8}],
  "notes": "–î–æ–±–∞–≤—å—Ç–µ –±–µ–ª–æ–∫ (–º—è—Å–æ, —è–π—Ü–∞) –¥–ª—è —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏"
}

–ó–∞–ø—Ä–æ—Å: "–≥—Ä–µ—á–∫–∞ —Å –∫—É—Ä–∏—Ü–µ–π"
–û—Ç–≤–µ—Ç: {
  "items": [
    {"name": "–ì—Ä–µ—á–∫–∞ –≤–∞—Ä–µ–Ω–∞—è", "weight_grams": 150, "calories": 150, "protein": 5.0, "fat": 1.0, "carbs": 30.0, "confidence": 0.8},
    {"name": "–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞", "weight_grams": 150, "calories": 165, "protein": 31.0, "fat": 3.6, "carbs": 0.0, "confidence": 0.8}
  ],
  "notes": "–û—Ç–ª–∏—á–Ω–æ–µ —Å–æ—á–µ—Ç–∞–Ω–∏–µ - —Ö–æ—Ä–æ—à–∏–π –±–∞–ª–∞–Ω—Å –±–µ–ª–∫–æ–≤ –∏ —É–≥–ª–µ–≤–æ–¥–æ–≤"
}

–ó–∞–ø—Ä–æ—Å: "–≤–µ–ª–æ—Å–∏–ø–µ–¥"
–û—Ç–≤–µ—Ç: {
  "items": [],
  "notes": "–≠—Ç–æ –Ω–µ –ø—Ä–æ–¥—É–∫—Ç –ø–∏—Ç–∞–Ω–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –µ–¥—ã –∏–ª–∏ –æ–ø–∏—à–∏—Ç–µ —á—Ç–æ –≤—ã —Å—ä–µ–ª–∏."
}

–ü–û–ú–ù–ò: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –¢–û–õ–¨–ö–û —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å! –ù–µ –¥–æ–±–∞–≤–ª—è–π –ª–∏—à–Ω–µ–≥–æ!
"""


async def ai_request(
    user_id: int,
    model: str = None,
    text: str = None,
    image_link: str = None
) -> tuple[int, str]:
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ OpenAI API
    
    Returns:
        tuple[status_code, response_text]
    """
    if model is None:
        model = settings.openai_default_model
    
    try:
        async with httpx.AsyncClient(timeout=60.0) as client:
            if not text and not image_link:
                logger.warning(f"[GPT] User {user_id}: empty request")
                return 400, ""

            messages = [
                {"role": "system", "content": OPENAI_PROMPT}
            ]
            
            user_content = []
            
            if text:
                user_content.append({
                    "type": "text",
                    "text": text
                })
            
            if image_link:
                user_content.append({
                    "type": "image_url",
                    "image_url": {
                        "url": image_link,
                        "detail": "high"
                    }
                })
            
            messages.append({
                "role": "user",
                "content": user_content
            })

            payload = {
                "model": model,
                "messages": messages,
                "temperature": 0.2,
                "max_tokens": 2000,
                "response_format": {"type": "json_object"}
            }
            
            headers = {
                "Authorization": f"Bearer {settings.openai_api_key}",
                "Content-Type": "application/json"
            }

            logger.info(
                f"[GPT] User {user_id}: sending request "
                f"(model={model}, text={bool(text)}, image={bool(image_link)})"
            )
            
            response = await client.post(
                settings.openai_api_url,
                headers=headers,
                json=payload
            )
            
            if response.status_code != 200:
                logger.error(
                    f"[GPT] User {user_id}: API error {response.status_code}: "
                    f"{response.text[:500]}"
                )
                return 400, ""

            result = response.json()
            reply = result["choices"][0]["message"]["content"]
            
            usage = result.get("usage", {})
            logger.info(
                f"[GPT] User {user_id}: success "
                f"(tokens: {usage.get('total_tokens', 0)}, "
                f"response: {len(reply)} chars)"
            )
            
            return 200, reply

    except httpx.TimeoutException:
        logger.error(f"[GPT] User {user_id}: timeout after 60s")
        return 408, ""
    except httpx.HTTPError as e:
        logger.error(f"[GPT] User {user_id}: HTTP error: {e}")
        return 400, ""
    except Exception as e:
        logger.exception(f"[GPT] User {user_id}: unexpected error: {e}")
        return 400, ""
